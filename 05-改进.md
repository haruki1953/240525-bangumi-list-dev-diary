
## 240710
- ç•ªå‰§å°é¢åå‘ä»£ç†
- å‰ç«¯å¯é‡å†™ç•ªå‰§æ•°æ®ä¸­çš„ç›¸å…³é“¾æŽ¥ï¼ˆå°é¢ã€alisté“¾æŽ¥ï¼‰
- è§£å†³â€œç‰©è¯­ç³»åˆ— å¤–ä¼ å­£&amp;æ€ªç‰©å­£â€ç‰¹æ®Šå­—ç¬¦æ˜¾ç¤ºé—®é¢˜
- å…³äºŽé¡µé¢æ·»åŠ å¯åŠ¨æ€æŽ§åˆ¶çš„å†…å®¹
- TDKå†æ”¹ä¸€ä¸‹ï¼ŒåŠ ç½‘é¡µå›¾ç‰‡
- BgmConfigç±»åž‹ä¸­ã€å¿˜äº†ç»™å…¶ä¸­çš„ä¸€äº›å±žæ€§è®¾ç½®ä¸ºå¯é€‰


### ç•ªå‰§å°é¢åå‘ä»£ç†
å› ä¸ºbgmçš„å›¾ç‰‡æœ‰æ—¶å€™åŠ è½½ä¸å‡ºæ¥ï¼Œè€Œä¸”å…¶æµè§ˆå™¨ç¼“å­˜åªæœ‰8å¤©ï¼Œæ‰€ä»¥çŽ°åœ¨åå‘ä»£ç†ä¸€ä¸‹ å¹¶å°†æµè§ˆå™¨ç¼“å­˜åŠ é•¿ä¸º180å¤©ï¼Œåœ¨é…ç½®ä¸€ä¸‹åå‘ä»£ç†ç¼“å­˜30å¤©

```
åŽŸ
https://lain.bgm.tv/r/400/pic/cover/l/98/5e/386809_1yR81.jpg
ä»£ç†åŽ
https://static.sakiko.top/bangumi-cover/l/98/5e/386809_1yR81.jpg
```
![](assets/Pasted%20image%2020240710153343.png)

```nginx
#PROXY-START/bangumi-cover/

location ^~ /bangumi-cover/
{
    proxy_pass https://lain.bgm.tv/r/400/pic/cover/;
    proxy_set_header Host lain.bgm.tv;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    # proxy_hide_header Upgrade;

    add_header X-Cache $upstream_cache_status;
		#Set Nginx Cache


    if ( $uri ~* "\.(gif|png|jpg|css|js|woff|woff2)$" )
    {
        expires 1m;
    }
    proxy_ignore_headers Set-Cookie Cache-Control expires;
    proxy_cache cache_one;
    proxy_cache_key $host$uri$is_args$args;
    proxy_cache_valid 200 304 301 302 43200m;
}

#PROXY-END/bangumi-cover/
```

é‡åˆ°äº†ä¸€ç‚¹é—®é¢˜ðŸ˜‡ï¼Œé—®é¢˜ä¸å°
ï¼ˆåœ°å€æ å¯¹ä¸ä¸Šæ˜¯å› ä¸ºåŽæ¥åˆæ”¹ä»£ç†ç›®å½•äº†ï¼ˆå¯èƒ½æ˜¯å› ä¸ºcfç¼“å­˜å¯¼è‡´äº†å¥‡æ€ªçš„é—®é¢˜ï¼Œæ‰€ä»¥æ”¹äº†ï¼‰ï¼‰
![](assets/Pasted%20image%2020240710173506.png)


#### é—®é¢˜æè¿°
##### 1. æ˜¯ä½¿ç”¨å®å¡”é¢æ¿é…ç½®çš„åå‘ä»£ç†
![](assets/Pasted%20image%2020240710200009.png)

åœ¨å…¶ä¸­ä¹Ÿå¯ä»¥çœ‹é…ç½®æ–‡ä»¶
![](assets/Pasted%20image%2020240710194933.png)
```nginx
#PROXY-START/bangumi-cover/

location ^~ /bangumi-cover1/
{
    proxy_pass https://lain.bgm.tv/r/400/pic/cover/;
    proxy_set_header Host lain.bgm.tv;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    # proxy_hide_header Upgrade;

    add_header X-Cache $upstream_cache_status;
		#Set Nginx Cache

    if ( $uri ~* "\.(gif|png|jpg|css|js|woff|woff2)$" )
    {
        expires 1m;
    }
    proxy_ignore_headers Set-Cookie Cache-Control expires;
    proxy_cache cache_one;
    proxy_cache_key $host$uri$is_args$args;
    proxy_cache_valid 200 304 301 302 43200m;
}

#PROXY-END/bangumi-cover/
```

ä¸Šé¢æ˜¯å•ç‹¬çš„åå‘ä»£ç†çš„é…ç½®ï¼Œä¼šè¢«ç½‘ç«™çš„é…ç½®æ–‡ä»¶include
![](assets/Pasted%20image%2020240710195516.png)

##### 2. åå‘ä»£ç†é…ç½®å¤±è´¥äº†
```
å›¾ç‰‡åŽŸæœ¬çš„é“¾æŽ¥æ˜¯ 
https://lain.bgm.tv/r/400/pic/cover/l/98/5e/386809_1yR81.jpg

ç»è¿‡åå‘ä»£ç†åŽåº”è¯¥æ˜¯ 
https://static.sakiko.top/bangumi-cover1/l/98/5e/386809_1yR81.jpg

ä½†æ˜¯è®¿é—®åŽå°±æ˜¯ä¸Šé¢çš„cfçš„502ç•Œé¢
```

è¿™å°±æ˜¯æœåŠ¡å™¨ä¸Šå‘ç”Ÿçš„äº‹ï¼Œè‡³äºŽä¸ºä»€ä¹ˆä¼šæ˜¾ç¤º cloudflare çš„æŠ¥é”™ï¼Œåº”è¯¥æ˜¯å› ä¸ºç”¨äº†cfçš„dnså’Œä»£ç†
![](assets/517a440bfb5ffbf15a6c798992e68f2.png)

ä»¥ä¸‹ç»“åˆå¦ä¸€ä¸ªè¢«æˆ‘åå‘ä»£ç†çš„ç½‘ç«™ï¼Œè¿˜æœ‰ä¸€ç‚¹çŒœæµ‹
![](assets/Pasted%20image%2020240710200908.png)
```
è¿™ä¸ªæ˜¯æ­£å¸¸çš„
åŽŸæœ¬çš„é“¾æŽ¥ä¸º
https://cdn.jsdelivr.net/npm/@widgetbot/crate@3
åå‘ä»£ç†åŽä¸º
https://static.sakiko.top/cdn_jsdelivr_net/npm/@widgetbot/crate@3

å¦‚æžœå°†å…¶æ•…æ„ä¿®æ”¹ä¸ºé”™çš„
https://static.sakiko.top/cdn_jsdelivr_net/npm/@widgetbot/crate@3aaaaaaa
å°±ä¼šå‡ºçŽ°cf502é¡µé¢
```

æœ‰æ—¶å€™ä¼šæ˜¯è¿™ä¸ªé¡µé¢ï¼Œä½†åˆ·æ–°å‡ ä¸‹å°±ä¼šå˜å›žcfçš„502é¡µé¢
![](assets/Pasted%20image%2020240710201455.png)
![](assets/Pasted%20image%2020240710201519.png)


#### å°è¯•è§£å†³
å†æ–°å»ºä¸€ä¸ªç«™ç‚¹è¯•è¯•ï¼Œå…ˆä¸ç”¨cfä»£ç†
![](assets/Pasted%20image%2020240711150036.png)
```
æ–°ç«™ç‚¹ï¼Œè®¿é—®æ˜¯æ­£å¸¸çš„
https://bgm-test-proxy.sakiko.top/

åŽŸå›¾ç‰‡
https://lain.bgm.tv/r/400/pic/cover/l/98/5e/386809_1yR81.jpg
ä»£ç†åŽçš„å›¾ç‰‡ï¼Œè¿˜æ˜¯502ï¼ˆä¸æ˜¯cfçš„é¡µé¢äº†ï¼Œæ˜¯nginxçš„502é¡µé¢ï¼‰
https://bgm-test-proxy.sakiko.top/bangumi-cover1/l/98/5e/386809_1yR81.jpg
```
![](assets/Pasted%20image%2020240711181253.png)

è®©è¿™ä¸ªåå‘ä»£ç†å†™å†™æ—¥å¿—è¯•è¯•
```
http
    {
      # 240711ç•ªå‰§å°é¢åå‘ä»£ç†æµ‹è¯•æ—¥å¿—æ ¼å¼
      log_format bangumi_cover_log 'ã€bangumi_cover_logã€‘'
				'$remote_addr - $remote_user [$time_local] "$request" '
				'$status $body_bytes_sent "$http_referer" '
				'"$http_user_agent" "$http_x_forwarded_for" '
				'upstream_addr: $upstream_addr '
				'upstream_status: $upstream_status '
				'upstream_response_time: $upstream_response_time '
				'upstream_connect_time: $upstream_connect_time '
				'upstream_header_time: $upstream_header_time '
				'request_time: $request_time '
				'upstream_cache_status: $upstream_cache_status '
				'proxy_host: $proxy_host '
				'proxy_add_x_forwarded_for: $proxy_add_x_forwarded_for';

access_log  /www/wwwlogs/bgm-test-proxy.sakiko.top.log bangumi_cover_log;
```

å¤šè®¿é—®äº†å‡ æ¬¡ï¼Œæ—¥å¿—ä¼šå‡ºçŽ°ä»¥ä¸‹ä¸¤ç§æƒ…å†µ
```
ã€bangumi_cover_logã€‘
117.136.107.34 - - [11/Jul/2024:15:36:14 +0800] ï¼‚GET /bangumi-cover1/l/98/5e/386809_1yR81.jpg HTTP/2.0ï¼‚ 502 552 ï¼‚-ï¼‚ ï¼‚Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36ï¼‚ ï¼‚-ï¼‚ 
upstream_addr: lain.bgm.tv 
upstream_status: 502 
upstream_response_time: 0.000 
upstream_connect_time: - 
upstream_header_time: - 
request_time: 0.000 
upstream_cache_status: MISS 
proxy_host: lain.bgm.tv 
proxy_add_x_forwarded_for: 117.136.107.34


ã€bangumi_cover_logã€‘
117.136.107.34 - - [11/Jul/2024:15:38:30 +0800] ï¼‚GET /bangumi-cover1/l/98/5e/386809_1yR81.jpg HTTP/2.0ï¼‚ 502 552 ï¼‚-ï¼‚ ï¼‚Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36ï¼‚ ï¼‚-ï¼‚ 
upstream_addr: [2606:4700:20::681a:917]:443, [2606:4700:20::ac43:4943]:443, [2606:4700:20::681a:817]:443, 172.67.73.67:443, 104.26.8.23:443, 104.26.9.23:443 
upstream_status: 502, 502, 502, 502, 502, 502 
upstream_response_time: 0.000, 0.000, 0.000, 0.003, 0.004, 0.005 
upstream_connect_time: -, -, -, -, -, - 
upstream_header_time: -, -, -, -, -, - 
request_time: 0.012 
upstream_cache_status: MISS 
proxy_host: lain.bgm.tv 
proxy_add_x_forwarded_for: 117.136.107.34
```
è¿”å›žçš„å“åº”è¿˜æ˜¯502


chatgptåˆ†æžäº†ä¸€å¤§å †ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªsslè®¾ç½®
```
proxy_ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # å¯ç”¨æ‰€æœ‰TLSç‰ˆæœ¬ 
proxy_ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-GCM-SHA256'; # å¹¿æ³›å…¼å®¹çš„åŠ å¯†å¥—ä»¶
```
è¯•äº†è¯•ï¼Œä¹Ÿæ²¡ç”¨


åœ¨æ–°å»ºçš„ç«™ç‚¹ä¸Šä¹Ÿé…ç½®äº†ä¸€ä¸ªæ­£å¸¸çš„åå‘ä»£ç†ï¼Œå¯¹æ¯”æµ‹è¯•
```
åŽŸæœ¬çš„é“¾æŽ¥ä¸º
https://cdn.jsdelivr.net/npm/@widgetbot/crate@3
åå‘ä»£ç†åŽä¸º
https://bgm-test-proxy.sakiko.top/cdn_jsdelivr_net/npm/@widgetbot/crate@3
ä¸€åˆ‡æ­£å¸¸
```
ä¹Ÿçœ‹çœ‹å®ƒçš„æ—¥å¿—
```
ã€bangumi_cover_logã€‘
106.34.76.116 - - [11/Jul/2024:17:57:57 +0800] ï¼‚GET /cdn_jsdelivr_net/npm/@widgetbot/crate@3 HTTP/2.0ï¼‚ 304 0 ï¼‚-ï¼‚ ï¼‚Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36ï¼‚ ï¼‚-ï¼‚ 
upstream_addr: - 
upstream_status: - 
upstream_response_time: - 
upstream_connect_time: - 
upstream_header_time: - 
request_time: 0.000 
upstream_cache_status: HIT 
proxy_host: cdn.jsdelivr.net 
proxy_add_x_forwarded_for: 106.34.76.116
è¿™ä¸ªæ˜¯å‘½ä¸­ç¼“å­˜äº†

æ¢ä¸€ä¸ªæ²¡æœ‰ç¼“å­˜çš„é“¾æŽ¥
https://bgm-test-proxy.sakiko.top/cdn_jsdelivr_net/npm/@widgetbot/crate@3.7.0/umd/crate.js

ã€bangumi_cover_logã€‘
106.34.76.116 - - [11/Jul/2024:17:56:34 +0800] ï¼‚GET /cdn_jsdelivr_net/npm/@widgetbot/crate@3.7.0/umd/crate.js HTTP/2.0ï¼‚ 200 123448 ï¼‚-ï¼‚ ï¼‚Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36ï¼‚ ï¼‚-ï¼‚ 
upstream_addr: 151.101.1.229:443 
upstream_status: 200 
upstream_response_time: 0.016 
upstream_connect_time: 0.004 
upstream_header_time: 0.006 
request_time: 0.402 
upstream_cache_status: MISS 
proxy_host: cdn.jsdelivr.net 
proxy_add_x_forwarded_for: 106.34.76.116
```
å¥½åƒå’Œ `/bangumi-cover1/` æ˜¯ä¸ä¸€æ ·çš„

ã€å…ˆä¸ç®¡äº†ã€‘

[nginxç•ªå‰§å›¾ç‰‡åå‘ä»£ç†é—®é¢˜](ç¬”è®°/nginxç•ªå‰§å›¾ç‰‡åå‘ä»£ç†é—®é¢˜.md)





### å‰ç«¯é‡å†™æ•°æ®ä¸­çš„é“¾æŽ¥
æ–°å»º `src\utils\dataHandler.ts`ï¼Œç”¨äºŽå¤„ç†èŽ·å–åˆ°çš„æ•°æ®

åœ¨é…ç½®æ–‡ä»¶é‡Œç¼–å†™æ›¿æ¢ä¿¡æ¯åˆ—è¡¨ï¼Œä»¥æ­¤åŒ¹é…äºŽæ›¿æ¢å¯¹åº”çš„ä¿¡æ¯ï¼Œæ›¿æ¢åˆ—è¡¨ä¸­åªä¼šç”Ÿæ•ˆä¸€ä¸ª
```ts
// src\types\utils.d.ts
export interface ReplaceConfig {
  pattern: RegExp
  replacement: string
}

// src\config\index.ts
export const bgmImgReplace: ReplaceConfig[] = [
  {
    pattern: /^\/\/lain\.bgm\.tv\/r\/400\/pic\/cover\//,
    replacement: 'https://static.sakiko.top/bangumi-cover/'
  }
]
export const alistPathReplace: ReplaceConfig[] = [
  {
    pattern: /^https:\/\/bangumi\.sakiko\.top\//,
    replacement: '/'
  }
]

// src\utils\dataHandler.ts
// ues a ReplaceConfigList to replace a string
const replaceHandler = (str: string, replaceList: ReplaceConfig[]) => {
  let newStr = str
  replaceList.some((replaceConfig) => {
    newStr = str.replace(replaceConfig.pattern, replaceConfig.replacement)
    // on success replace, return true to break
    if (newStr !== str) {
      return true
    }
  })
  return newStr
}

export const handleBgmData = (bgm: BgmData): BgmData => {
  const newAlistPath = replaceHandler(bgm.alistPath, alistPathReplace)
  const newImg = replaceHandler(bgm.img, bgmImgReplace)
  return {
    ...bgm,
    alistPath: newAlistPath,
    img: newImg
  }
}
```


### è§£å†³ç‰¹æ®Šå­—ç¬¦æ˜¾ç¤ºé—®é¢˜
```ts
// src\utils\dataHandler.ts
// Special Characters handler
const specCharsHandler = (str: string): string => {
  const entities: { [key: string]: string } = {
    '&amp;': '&',
    '&lt;': '<',
    '&gt;': '>',
    '&quot;': '"',
    '&#39': "'"
  }
  return str.replace(/&.+?;/g, (entity) => entities[entity] || entity)
}

export const handleBgmData = (bgm: BgmData): BgmData => {
  const newAlistPath = replaceHandler(bgm.alistPath, alistPathReplace)
  const newImg = replaceHandler(bgm.img, bgmImgReplace)
  const newName = specCharsHandler(bgm.name)
  const newChineseName = specCharsHandler(bgm.chineseName)
  return {
    ...bgm,
    alistPath: newAlistPath,
    img: newImg,
    name: newName,
    chineseName: newChineseName
  }
}
```

ok
![](assets/Pasted%20image%2020240713191035.png)

