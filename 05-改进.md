
## 240710
- ç•ªå‰§å°é¢åå‘ä»£ç†
- å‰ç«¯å¯é‡å†™ç•ªå‰§æ•°æ®ä¸­çš„ç›¸å…³é“¾æ¥ï¼ˆå°é¢ã€alisté“¾æ¥ï¼‰
- å…³äºé¡µé¢æ·»åŠ å¯åŠ¨æ€æ§åˆ¶çš„å†…å®¹
- TDKå†æ”¹ä¸€ä¸‹ï¼ŒåŠ ç½‘é¡µå›¾ç‰‡
- BgmConfigç±»å‹ä¸­ã€å¿˜äº†ç»™å…¶ä¸­çš„ä¸€äº›å±æ€§è®¾ç½®ä¸ºå¯é€‰
- è§£å†³â€œç‰©è¯­ç³»åˆ— å¤–ä¼ å­£&amp;æ€ªç‰©å­£â€ç‰¹æ®Šå­—ç¬¦æ˜¾ç¤ºé—®é¢˜

### ç•ªå‰§å°é¢åå‘ä»£ç†
å› ä¸ºbgmçš„å›¾ç‰‡æœ‰æ—¶å€™åŠ è½½ä¸å‡ºæ¥ï¼Œè€Œä¸”å…¶æµè§ˆå™¨ç¼“å­˜åªæœ‰8å¤©ï¼Œæ‰€ä»¥ç°åœ¨åå‘ä»£ç†ä¸€ä¸‹ å¹¶å°†æµè§ˆå™¨ç¼“å­˜åŠ é•¿ä¸º180å¤©ï¼Œåœ¨é…ç½®ä¸€ä¸‹åå‘ä»£ç†ç¼“å­˜30å¤©

```
åŸ
https://lain.bgm.tv/r/400/pic/cover/l/98/5e/386809_1yR81.jpg
ä»£ç†å
https://static.sakiko.top/bangumi-cover/l/98/5e/386809_1yR81.jpg
```
![](assets/Pasted%20image%2020240710153343.png)

```nginx
#PROXY-START/bangumi-cover/

location ^~ /bangumi-cover/
{
    proxy_pass https://lain.bgm.tv/r/400/pic/cover/;
    proxy_set_header Host lain.bgm.tv;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    # proxy_hide_header Upgrade;

    add_header X-Cache $upstream_cache_status;
		#Set Nginx Cache


    if ( $uri ~* "\.(gif|png|jpg|css|js|woff|woff2)$" )
    {
        expires 1m;
    }
    proxy_ignore_headers Set-Cookie Cache-Control expires;
    proxy_cache cache_one;
    proxy_cache_key $host$uri$is_args$args;
    proxy_cache_valid 200 304 301 302 43200m;
}

#PROXY-END/bangumi-cover/
```

é‡åˆ°äº†ä¸€ç‚¹é—®é¢˜ğŸ˜‡ï¼Œé—®é¢˜ä¸å°
ï¼ˆåœ°å€æ å¯¹ä¸ä¸Šæ˜¯å› ä¸ºåæ¥åˆæ”¹ä»£ç†ç›®å½•äº†ï¼ˆå¯èƒ½æ˜¯å› ä¸ºcfç¼“å­˜å¯¼è‡´äº†å¥‡æ€ªçš„é—®é¢˜ï¼Œæ‰€ä»¥æ”¹äº†ï¼‰ï¼‰
![](assets/Pasted%20image%2020240710173506.png)


#### é—®é¢˜æè¿°ã€ç»™ é˜¿niã€‘

##### 1. æ˜¯ä½¿ç”¨å®å¡”é¢æ¿é…ç½®çš„åå‘ä»£ç†
![](assets/Pasted%20image%2020240710200009.png)

åœ¨å…¶ä¸­ä¹Ÿå¯ä»¥çœ‹é…ç½®æ–‡ä»¶
![](assets/Pasted%20image%2020240710194933.png)
```nginx
#PROXY-START/bangumi-cover/

location ^~ /bangumi-cover1/
{
    proxy_pass https://lain.bgm.tv/r/400/pic/cover/;
    proxy_set_header Host lain.bgm.tv;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    # proxy_hide_header Upgrade;

    add_header X-Cache $upstream_cache_status;
		#Set Nginx Cache

    if ( $uri ~* "\.(gif|png|jpg|css|js|woff|woff2)$" )
    {
        expires 1m;
    }
    proxy_ignore_headers Set-Cookie Cache-Control expires;
    proxy_cache cache_one;
    proxy_cache_key $host$uri$is_args$args;
    proxy_cache_valid 200 304 301 302 43200m;
}

#PROXY-END/bangumi-cover/
```

ä¸Šé¢æ˜¯å•ç‹¬çš„åå‘ä»£ç†çš„é…ç½®ï¼Œä¼šè¢«ç½‘ç«™çš„é…ç½®æ–‡ä»¶include
![](assets/Pasted%20image%2020240710195516.png)

##### 2. åå‘ä»£ç†é…ç½®å¤±è´¥äº†
```
å›¾ç‰‡åŸæœ¬çš„é“¾æ¥æ˜¯ 
https://lain.bgm.tv/r/400/pic/cover/l/98/5e/386809_1yR81.jpg

ç»è¿‡åå‘ä»£ç†ååº”è¯¥æ˜¯ 
https://static.sakiko.top/bangumi-cover1/l/98/5e/386809_1yR81.jpg

ä½†æ˜¯è®¿é—®åå°±æ˜¯ä¸Šé¢çš„cfçš„502ç•Œé¢
```

è¿™å°±æ˜¯æœåŠ¡å™¨ä¸Šå‘ç”Ÿçš„äº‹ï¼Œè‡³äºä¸ºä»€ä¹ˆä¼šæ˜¾ç¤º cloudflare çš„æŠ¥é”™ï¼Œåº”è¯¥æ˜¯å› ä¸ºç”¨äº†cfçš„dnså’Œä»£ç†
![](assets/517a440bfb5ffbf15a6c798992e68f2.png)

ä»¥ä¸‹ç»“åˆå¦ä¸€ä¸ªè¢«æˆ‘åå‘ä»£ç†çš„ç½‘ç«™ï¼Œè¿˜æœ‰ä¸€ç‚¹çŒœæµ‹
![](assets/Pasted%20image%2020240710200908.png)
```
è¿™ä¸ªæ˜¯æ­£å¸¸çš„
åŸæœ¬çš„é“¾æ¥ä¸º
https://cdn.jsdelivr.net/npm/@widgetbot/crate@3
åå‘ä»£ç†åä¸º
https://static.sakiko.top/cdn_jsdelivr_net/npm/@widgetbot/crate@3

å¦‚æœå°†å…¶æ•…æ„ä¿®æ”¹ä¸ºé”™çš„
https://static.sakiko.top/cdn_jsdelivr_net/npm/@widgetbot/crate@3aaaaaaa
å°±ä¼šå‡ºç°cf502é¡µé¢
```

æœ‰æ—¶å€™ä¼šæ˜¯è¿™ä¸ªé¡µé¢ï¼Œä½†åˆ·æ–°å‡ ä¸‹å°±ä¼šå˜å›cfçš„502é¡µé¢
![](assets/Pasted%20image%2020240710201455.png)
![](assets/Pasted%20image%2020240710201519.png)