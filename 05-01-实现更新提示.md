github: https://github.com/haruki1953/qb_auto

项目背景
- https://sakiko.xlog.app/vps-auto-bangumi
- https://github.com/haruki1953/bangumi-list-vue3
- https://github.com/haruki1953/crawl_post_generator

## 想到办法实现番剧小窝的更新提示了
就像自己最早搭建自动追番时提到的，qb番剧下载后，会执行一个脚本来将文件发送到onedrive。
![](assets/Pasted%20image%2020241026161954.png) 

可以通过这个来实现番剧的更新记录。其实脚本本身就有记录日志，再改起来应该很容易。可以将其信息再保存至网站目录下的一个文件，然后前端来获取，实现番剧更新提示（卡片上显示“new标签”）
![](assets/Pasted%20image%2020241026162112.png) 
![](assets/Pasted%20image%2020241026162309.png) 

决定在脚本最后调用 python 脚本来处理数据
```sh
# 调用 Python 脚本并传递参数
# python3
python ./bangumi-update.py "$torrent_name" "$content_dir" "$root_dir" "$save_dir" "$files_num" "$torrent_size" "$file_hash"
```


### update.json 数据类型
```ts
interface BgmUpdateInfo {
	fileName: string
	filePath: string
	fileSize: number
	fileHash: string
	fileDate: string
}
```

示例 update.json
```json
[
    {
        "fileName": "[LoliHouse] Kabushikigaisha Magi-Lumière - 04 [WebRip 1080p HEVC-10bit AAC SRTx2].mkv",
        "filePath": "/root/Downloads/Sakiko/Bangumi/魔法光源股份有限公司/Season 1",
        "fileSize": 788255263,
        "fileHash": "2f258c68b2adf2819b6ddb64aea927091b7bd49c",
        "fileDate": "2024-10-26T20:36:00.858755"
    },
    {
        "fileName": "[ANi] 蜻蛉高球 - 17 [1080P][Baha][WEB-DL][AAC AVC][CHT].mp4",
        "filePath": "/root/Downloads/Sakiko/Bangumi/喂！蜻蜓/Season 1",
        "fileSize": 368911875,
        "fileHash": "e30e46e1e6ad498a31c1fc9ce814ce969bcf2acf",
        "fileDate": "2024-10-26T20:35:59.731397"
    }
]
```

### config.json 添加了 bgmLastUpdate
脚本每次执行，将修改 config.json 的 bgmLastUpdate 字段，保存当前时间
```json
{
    "bgmLastUpdate": "2024-10-26T20:36:00.861753"
}
```

前端据此在 bgmLastUpdate 变化时再重新获取update.json

### 部署

修改配置后，复制 bangumi-update.py 至 /root/qbauto ，然后修改 qb_auto.sh 在其底部添加
```sh
# 调用 Python 脚本并传递参数
python3 /root/qbauto/bangumi-update.py "$torrent_name" "$content_dir" "$root_dir" "$save_dir" "$files_num" "$torrent_size" "$file_hash"
```


## 前端修改

先写样式，顺便改进一些问题
- 将本地开发的番剧数据和服务器同步
- 排序开关和下面的卡片距离应再大一些
- 小屏时侧边距再小一点
- 为减小延迟，将IconMenu触发方式改为mousedown、touchstart，这个重复触发也不影响

bangumiStore 添加 bgmLastUpdate，bgmUpdateList，bgmUpdateReadHash
```ts
    // 番剧更新时间
    const bgmLastUpdate = ref<string | null>('')
    // 番剧更新数据
    const bgmUpdateList = ref<BgmUpdateInfo[]>([])
    // 已读番剧更新，保存Hash
    const bgmUpdateReadHash = ref<string[]>([])
```

为 bangumiStore 编写 updateModule


### OK
https://bangumi.sakiko.top

终于给番剧小窝实现了番剧的更新提示，感觉变得活跃了很多

这个自动追番是通过 qbittorrent + RSS 实现的，在 qb 完成下载后会执行一个脚本上传至 onedrive。这个脚本本身就记录了日志，所以顺便保存更新信息也是挺容易的，前端再请求获取就可以实现番剧更新提示。

### 添加番剧更新页
